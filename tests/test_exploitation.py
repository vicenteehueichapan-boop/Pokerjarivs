import unittest
from poker_brain.model import GameContext, Hero, Villain
from poker_brain.strategy import StrategyEngine

class TestPositionAwareness(unittest.TestCase):

    def setUp(self):
        self.engine = StrategyEngine()

    def test_position_impact_on_equity(self):
        """
        Test: Hero holds Top Pair (weak kicker).

        Board: A 8 2
        Hero: A 5
        """
        hero = Hero(position="SB", cards=["Ah", "5d"], stack=1000, current_investment=0)
        board = ["Ad", "8s", "2c"]

        # 1. UTG Villain
        villain_utg = Villain(position="UTG", status="ACTIVE", stack=1000, current_investment=0)

        # 2. BTN Villain
        villain_btn = Villain(position="BTN", status="ACTIVE", stack=1000, current_investment=0)

        # Calculate Equity
        equity_vs_utg = self.engine.estimate_equity(hero.cards, board, villain_utg, simulations=2000)
        equity_vs_btn = self.engine.estimate_equity(hero.cards, board, villain_btn, simulations=2000)

        print(f"Equity vs UTG (Tight): {equity_vs_utg:.3f}")
        print(f"Equity vs BTN (Wide): {equity_vs_btn:.3f}")

        self.assertGreater(equity_vs_btn, equity_vs_utg + 0.05, "Equity vs Button should be at least 5% higher than vs UTG")

    def test_blind_defense_logic(self):
        """
        Test that we assign a wide range to BB.
        """
        hero = Hero(position="BTN", cards=["Ks", "Qd"], stack=1000, current_investment=0)
        board = ["Jh", "Th", "2s"] # Open ended straight draw + overcards

        villain_bb = Villain(position="BB", status="ACTIVE", stack=1000, current_investment=0)

        equity = self.engine.estimate_equity(hero.cards, board, villain_bb, simulations=1000)
        print(f"KQ vs BB on JT2: {equity:.3f}")

        # KQ high vs Range BB (includes many pairs like 22, 55, Jx, Tx).
        # We are behind against made hands, but ahead of draws.
        # 40% equity is very strong for a draw.
        self.assertGreater(equity, 0.40)

if __name__ == '__main__':
    unittest.main()
